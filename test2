const express = require('express');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const verifyToken = require('./authMiddleware');

const app = express();
const PORT = 5000;
const SECRET_KEY = 'your_secret_key';

app.use(express.json());

// 🔐 Route to generate token (simulate login)
app.post('/api/login', (req, res) => {
  const { username } = req.body;
  const token = jwt.sign({ username }, SECRET_KEY, { expiresIn: '1h' });
  res.json({ token });
});

// ✅ Protected POST endpoint
app.post('/api/process', verifyToken, async (req, res) => {
  const { name, age } = req.body;
  console.log('Received from frontend:', name, age);

  try {
    const apiResponse = await axios.post('https://jsonplaceholder.typicode.com/posts', {
      title: `User: ${name}`,
      body: `Age is ${age}`,
      userId: 1,
    });

    res.json({
      message: 'Data processed and sent to another API',
      apiResponse: apiResponse.data,
    });
  } catch (error) {
    console.error('Error calling external API:', error);
    res.status(500).json({ error: 'API call failed' });
  }
});

app.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}`);
});
